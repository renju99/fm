<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Planned Maintenance Work Order Form View -->
    <record id="view_planned_maintenance_workorder_form" model="ir.ui.view">
        <field name="name">facilities.workorder.planned.form</field>
        <field name="model">facilities.workorder</field>
        <field name="priority" eval="15"/>
        <field name="arch" type="xml">
            <form>
                <header>
                    <field name="approval_state" widget="statusbar"
                        statusbar_visible="draft,submitted,supervisor,manager,approved,in_progress,done,refused,escalated,cancelled"
                        statusbar_colors='{"refused":"red","escalated":"orange","done":"green","cancelled":"red"}'/>
                    <field name="status"/>
                    <field name="all_tasks_completed"/>
                    <field name="show_standalone_tasks"/>
                    
                    <!-- Approval Workflow Buttons -->
                    <button name="action_submit_for_approval" type="object" string="Submit for Approval" class="oe_highlight"
                        invisible="approval_state != 'draft'"/>
                    <button name="action_supervisor_approve" type="object" string="Supervisor Approve" class="oe_highlight"
                        invisible="approval_state != 'submitted'"/>
                    <button name="action_manager_approve" type="object" string="Manager Approve" class="oe_highlight"
                        invisible="approval_state != 'manager'"/>
                    <button name="action_fully_approve" type="object" string="Fully Approve" class="oe_highlight"
                        invisible="approval_state != 'manager'"/>
                    
                    <!-- Action Buttons -->
                    <button name="action_start_progress" type="object" string="Start Workorder" class="oe_highlight"
                        invisible="approval_state not in ('approved', 'draft', 'submitted', 'supervisor', 'manager')"
                        confirm="Are you sure you want to start this planned maintenance work order? This will mark it as in progress."/>
                    <button name="action_resume_work" type="object" string="Resume Work" class="oe_highlight"
                        invisible="status != 'on_hold'"/>
                    <button name="action_complete" type="object" string="Mark as Completed" class="oe_highlight"
                        invisible="status != 'in_progress'"
                        confirm="Are you sure you want to mark this Planned Maintenance Work Order as completed? All tasks will be set as completed."/>
                    
                    <!-- Management Buttons -->
                    <button name="action_refuse" type="object" string="Refuse" class="btn-danger"
                        invisible="approval_state in ('refused','done','cancelled') or status == 'done'"/>
                    <button name="action_cancel" type="object" string="Cancel"
                        invisible="status in ('done', 'cancelled')"/>
                    <button name="action_reset_to_draft" type="object" string="Reset to Draft"
                        invisible="status == 'draft'"
                        confirm="Are you sure you want to reset this planned maintenance work order to draft state? This action cannot be undone easily."/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" name="action_view_picking" type="object" icon="fa-truck"
                            invisible="picking_count == 0">
                            <field name="picking_count" widget="statinfo" string="Parts Transfers"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1><field name="name" placeholder="Planned Maintenance Work Order Reference"/></h1>
                    </div>
                    
                    <!-- Planned Maintenance Specific Information -->
                    <div class="alert alert-info mb-3" role="alert">
                        <i class="fa fa-calendar-check-o me-2" title="Planned Maintenance"></i>
                        <strong>Planned Maintenance Work Order:</strong> This work order was generated from a maintenance schedule and follows a structured maintenance plan.
                    </div>
                    
                    <group>
                        <group string="Work Order Details" col="2">
                            <field name="asset_id" options="{'no_create': True}"/>
                            <field name="facility_id" readonly="1"/>
                            <field name="room_id" readonly="1"/>
                            <field name="building_id" readonly="1"/>
                            <field name="floor_id" readonly="1"/>
                            <field name="work_order_type" readonly="1"/>
                            <field name="priority"/>
                        </group>
                        <group string="Personnel &amp; Scheduled Dates" col="2">
                            <field name="technician_id"/>
                            <field name="supervisor_id" readonly="1"/>
                            <field name="manager_id" readonly="1"/>
                            <field name="start_date" readonly="start_date_readonly or sla_dates_readonly"/>
                            <field name="end_date" readonly="sla_dates_readonly"/>
                        </group>
                    </group>
                    
                    <!-- Maintenance Schedule Information (Always Visible for Planned Maintenance) -->
                    <group string="Maintenance Schedule Information" colspan="2" col="2">
                        <group string="Schedule Details" col="2">
                            <field name="schedule_id"
                                domain="[('active','=',True), ('asset_id','=',asset_id)]"
                                context="{'default_asset_id': asset_id}"
                                readonly="1"
                                help="Maintenance schedule linked to this preventive work order (read-only)"/>
                            <field name="job_plan_id"
                                readonly="status != 'draft'"
                                required="work_order_type == 'preventive'"
                                help="Select a Job Plan to automatically populate tasks for this planned maintenance work order"/>
                        </group>
                        <group string="Service Details" col="2">
                            <field name="service_type"/>
                            <field name="maintenance_team_id"/>
                            <field name="analytic_account_id"/>
                            <field name="partner_id"/>
                            <field name="contract_id"/>
                        </group>
                    </group>
                    
                    <group string="Approval Details" colspan="2" col="2">
                        <group string="Submission Info" col="2">
                            <field name="submitted_by_id" readonly="1"/>
                            <field name="approval_request_date" readonly="1"/>
                        </group>
                        <group string="Approval Info" col="2">
                            <field name="approved_by_id" readonly="1"/>
                            <field name="escalation_deadline" readonly="1"/>
                        </group>
                        <group string="Escalation Info" col="2">
                            <field name="escalation_to_id" readonly="1"/>
                            <field name="escalation_count" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Actual Work Dates" col="2">
                        <field name="actual_start_date" readonly="sla_dates_readonly"/>
                        <field name="actual_end_date" readonly="sla_dates_readonly"/>
                    </group>
                    
                    <group string="SLA Information" colspan="2" col="2">
                        <group string="SLA Details" col="2">
                            <field name="sla_id" readonly="1" help="SLA is automatically assigned based on priority and facility"/>
                            <field name="sla_deadline" readonly="1"/>
                        </group>
                        <group string="Response Tracking" col="2">
                            <field name="sla_response_deadline" readonly="1"/>
                            <field name="sla_response_status" widget="badge"/>
                        </group>
                        <group string="Resolution Tracking" col="2">
                            <field name="sla_resolution_deadline" readonly="1"/>
                            <field name="sla_resolution_status" widget="badge"/>
                        </group>
                        <group string="SLA Status &amp; Escalation" col="2">
                            <field name="sla_status" widget="badge"/>
                            <field name="sla_escalation_level"/>
                        </group>
                        <group string="Escalation Trigger" col="2">
                            <field name="escalation_triggered"/>
                        </group>
                        <div class="alert alert-info" role="alert">
                            <strong>Note:</strong> SLA is automatically assigned based on work order priority and facility, and cannot be manually changed.
                        </div>
                        <button name="action_recalculate_sla" type="object" string="Recalculate SLA" class="btn btn-secondary"
                                help="Recalculate SLA based on current priority and facility settings"/>
                    </group>
                    
                    <group string="KPI Metrics" colspan="2" col="2">
                        <group string="Performance Metrics" col="2">
                            <field name="mttr"/>
                            <field name="first_time_fix"/>
                        </group>
                        <group string="Cost &amp; Time Tracking" col="2">
                            <field name="downtime_hours"/>
                            <field name="cost_per_workorder"/>
                        </group>
                        <group string="Assignment Metrics" col="2">
                            <field name="total_assignment_labor_cost"/>
                            <field name="total_assignment_hours"/>
                        </group>
                        <group string="Quality Metrics" col="2">
                            <!-- <field name="skill_match_score"/> Commented out - field not available -->
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Maintenance Tasks">
                            <!-- Task Management Header -->
                            <div class="alert alert-info mb-3" role="alert">
                                <i class="fa fa-tasks me-2" title="Maintenance Tasks"></i>
                                <strong>Planned Maintenance Tasks:</strong> These tasks are part of the structured maintenance plan. 
                                Use the job plan selector above to automatically populate standardized maintenance procedures.
                            </div>
                            
                            <!-- Quick Task Actions -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <button name="action_add_task" type="object" string="Add New Task" class="btn btn-primary"
                                            invisible="status not in ('draft', 'assigned')"
                                            help="Add a new task to this planned maintenance work order"/>
                                    <button name="action_import_job_plan" type="object" string="Import from Job Plan" class="btn btn-secondary"
                                            invisible="work_order_type != 'preventive' or status not in ('draft', 'assigned')"
                                            help="Import standardized tasks from the selected job plan"/>
                                </div>
                                <div class="col-md-6 text-end">
                                    <span class="badge badge-info" style="font-size:12px;">
                                        <i class="fa fa-tasks me-1" title="Task Count"></i>
                                        Total Tasks: <field name="total_task_count" readonly="1"/>
                                    </span>
                                    <span class="badge badge-success ms-2" style="font-size:12px;">
                                        <i class="fa fa-check me-1"></i>
                                        Completed: <field name="completed_task_count" readonly="1"/>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Sections and Tasks -->
                            <field name="section_ids" create="false" delete="false">
                                <list>
                                    <field name="sequence"/>
                                    <field name="name"/>
                                    <field name="task_count" string="Tasks" readonly="1"/>
                                    <field name="completed_task_count" string="Completed" readonly="1"/>
                                    <field name="completion_percentage" string="Progress" readonly="1" widget="progressbar"/>
                                </list>
                                <form>
                                    <group>
                                        <field name="name" readonly="1"/>
                                        <field name="sequence" readonly="1"/>
                                    </group>
                                    
                                    <!-- Section Tasks -->
                                    <notebook>
                                        <page string="Tasks">
                                            <field name="task_ids">
                                                <list editable="bottom" create="true" delete="true">
                                                    <field name="sequence" readonly="1"/>
                                                    <field name="name" readonly="1"/>
                                                    <field name="description" readonly="1"/>
                                                    <field name="is_checklist_item" readonly="1"/>
                                                    <field name="is_done" widget="boolean_toggle"/>
                                                    <field name="duration"/>
                                                    <field name="responsible_id"/>
                                                    <field name="tools_materials"/>
                                                    <field name="notes"/>
                                                    <field name="before_image" widget="image"/>
                                                    <field name="after_image" widget="image"/>
                                                </list>
                                            </field>
                                        </page>
                                        <page string="Section Details">
                                            <group>
                                                <field name="name"/>
                                                <field name="sequence"/>
                                            </group>
                                        </page>
                                    </notebook>
                                </form>
                            </field>
                            
                            <!-- Standalone Tasks (without sections) -->
                            <div invisible="not show_standalone_tasks" class="mt-3">
                                <h4 style="color:#6c757d; margin-bottom:15px;">
                                    <i class="fa fa-list me-2"></i>General Tasks
                                </h4>
                                <field name="workorder_task_ids" create="true" delete="true">
                                    <list editable="bottom">
                                        <field name="sequence" readonly="1"/>
                                        <field name="name" readonly="1"/>
                                        <field name="description" readonly="1"/>
                                        <field name="is_checklist_item" readonly="1"/>
                                        <field name="is_done" widget="boolean_toggle"/>
                                        <field name="duration"/>
                                        <field name="responsible_id"/>
                                        <field name="tools_materials"/>
                                        <field name="notes"/>
                                        <field name="before_image" widget="image"/>
                                        <field name="after_image" widget="image"/>
                                    </list>
                                </field>
                            </div>
                            
                            <!-- Task Summary -->
                            <div class="mt-3 p-3 bg-light rounded">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="border-end">
                                            <h5 class="text-muted mb-1">Total Tasks</h5>
                                            <span class="h3 text-primary"><field name="total_task_count" readonly="1"/></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="border-end">
                                            <h5 class="text-muted mb-1">Completed</h5>
                                            <span class="h3 text-success"><field name="completed_task_count" readonly="1"/></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="border-end">
                                            <h5 class="text-muted mb-1">Pending</h5>
                                            <span class="h3 text-warning"><field name="pending_task_count" readonly="1"/></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="border-end">
                                            <h5 class="text-muted mb-1">Progress</h5>
                                            <div class="progress" style="height:30px;">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: 100%">
                                                    <field name="task_completion_percentage" readonly="1"/>%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </page>
                        <page string="Work Done">
                            <field name="work_done"/>
                        </page>
                        <page string="Technician Assignments">
                            <field name="assignment_ids">
                                <list editable="bottom" create="true" delete="true">
                                    <field name="technician_id"/>
                                    <field name="start_date"/>
                                    <field name="end_date"/>
                                    <field name="work_hours" readonly="1"/>
                                    <field name="work_minutes" readonly="1"/>
                                    <field name="status" widget="selection"/>
                                    <field name="hourly_rate" readonly="1"/>
                                    <field name="labor_cost" readonly="1"/>
                                    <field name="notes"/>
                                    <button name="action_start_work" type="object" string="Start" class="btn btn-success btn-sm" icon="fa-play"/>
                                    <button name="action_pause_work" type="object" string="Pause" class="btn btn-warning btn-sm" icon="fa-pause"/>
                                    <button name="action_resume_work" type="object" string="Resume" class="btn btn-info btn-sm" icon="fa-refresh"/>
                                    <button name="action_complete_work" type="object" string="Complete" class="btn btn-primary btn-sm" icon="fa-check"/>
                                </list>
                            </field>
                        </page>
                        <page string="Parts Used">
                            <field name="parts_used_ids">
                                <list editable="bottom">
                                    <field name="product_id"/>
                                    <field name="quantity"/>
                                    <field name="uom_id"/>
                                    <field name="product_qty_in_hand"/>
                                    <field name="notes"/>
                                </list>
                            </field>
                        </page>
                        <page string="Permits">
                            <field name="permit_ids">
                                <list editable="bottom">
                                    <field name="name"/>
                                    <field name="permit_type"/>
                                    <field name="status"/>
                                    <field name="issued_date"/>
                                    <field name="expiry_date"/>
                                </list>
                            </field>
                        </page>
                        <page string="Escalation History">
                            <div class="alert alert-info mb-3" role="alert">
                                <i class="fa fa-info-circle me-2" title="Escalation Information"></i>
                                <strong>Escalation History</strong> - This section shows automatic escalations triggered by SLA breaches. 
                                Escalations are automatically created when work orders exceed their SLA deadlines and cannot be manually edited.
                            </div>
                            <field name="escalation_history" create="false" delete="false" readonly="1">
                                <list  readonly="1">
                                    <field name="escalation_level" string="Level" readonly="1"/>
                                    <field name="escalation_type" string="Type" readonly="1"/>
                                    <field name="escalation_date" string="Triggered At" widget="datetime" readonly="1"/>
                                    <field name="escalation_reason" string="Reason" readonly="1"/>
                                    <field name="escalated_to_id" string="Escalated To" optional="show" readonly="1"/>
                                    <field name="resolution_date" string="Resolved At" widget="datetime" optional="show" readonly="1"/>
                                    <field name="status" string="Status" readonly="1"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Planned Maintenance Work Order Tree View -->
    <record id="view_planned_maintenance_workorder_tree" model="ir.ui.view">
        <field name="name">facilities.workorder.planned.tree</field>
        <field name="model">facilities.workorder</field>
        <field name="priority" eval="15"/>
        <field name="arch" type="xml">
            <list decoration-success="status=='done'"
                  decoration-danger="status=='cancelled'"
                  decoration-info="status=='in_progress'"
                  decoration-warning="status=='on_hold' or sla_status=='at_risk'"
                  default_order="start_date desc">
                <field name="name"/>
                <field name="status"/>
                <field name="asset_id"/>
                <field name="priority"/>
                <field name="technician_id"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="sla_status" widget="badge"/>
            </list>
        </field>
    </record>

    <!-- Planned Maintenance Work Order Search View -->
    <record id="view_planned_maintenance_workorder_search" model="ir.ui.view">
        <field name="name">facilities.workorder.planned.search</field>
        <field name="model">facilities.workorder</field>
        <field name="priority" eval="15"/>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="asset_id"/>
                <field name="facility_id"/>
                <field name="room_id"/>
                <field name="building_id"/>
                <field name="floor_id"/>
                <field name="technician_id"/>
                <field name="supervisor_id"/>
                <field name="manager_id"/>
                <field name="schedule_id"/>
                <field name="job_plan_id"/>
                <field name="sla_id"/>
                <field name="service_type"/>
                <field name="maintenance_team_id"/>
                
                <separator/>
                
                <filter string="Assigned to Me" name="assigned_to_me" domain="[('technician_id','=',uid)]"/>
                
                <separator/>
                
                <filter string="Draft" name="draft" domain="[('state','=','draft')]"/>
                <filter string="In Progress" name="in_progress" domain="[('state','=','in_progress')]"/>
                <filter string="Completed" name="completed" domain="[('state','=','completed')]"/>
                <filter string="Cancelled" name="cancelled" domain="[('state','=','cancelled')]"/>
                <filter string="On Hold" name="on_hold" domain="[('state','=','on_hold')]"/>
                
                <separator/>
                
                <filter string="SLA At Risk" name="sla_at_risk" domain="[('sla_status','=','at_risk')]"/>
                <filter string="SLA Breached" name="sla_breached" domain="[('sla_status','=','breached')]"/>
                <filter string="SLA On Time" name="sla_on_time" domain="[('sla_status','=','on_time')]"/>
                
                <separator/>
                
                <filter string="High Priority" name="high_priority" domain="[('priority','in',['3','4'])]"/>
                <filter string="Critical Priority" name="critical_priority" domain="[('priority','=','4')]"/>
                
                <separator/>
                
                <filter string="Escalation Triggered" name="escalation_triggered" domain="[('escalation_triggered','=',True)]"/>
                
                <separator/>
                
                <!-- Planned Maintenance Specific Filters -->
                <filter string="With Job Plan" name="with_job_plan" domain="[('job_plan_id','!=',False)]"/>
                <filter string="Without Job Plan" name="without_job_plan" domain="[('job_plan_id','=',False)]"/>
                <filter string="Scheduled This Week" name="scheduled_this_week" 
                        domain="[('start_date','&gt;=',context_today()),('start_date','&lt;=',(context_today() + relativedelta(weeks=1)))]"/>
                <filter string="Overdue" name="overdue" domain="[('start_date','&lt;',context_today()),('status','not in',['done','cancelled'])]"/>
                
            <filter string="Status" name="group_status" context="{'group_by': 'state'}"/>
            <filter string="Asset" name="group_asset" context="{'group_by': 'asset_id'}"/>
            <filter string="Facility" name="group_facility" context="{'group_by': 'facility_id'}"/>
            <filter string="Technician" name="group_technician" context="{'group_by': 'technician_id'}"/>
            <filter string="Schedule" name="group_schedule" context="{'group_by': 'schedule_id'}"/>
            <filter string="Job Plan" name="group_job_plan" context="{'group_by': 'job_plan_id'}"/>
            <filter string="SLA Status" name="group_sla_status" context="{'group_by': 'sla_status'}"/>
            <filter string="Priority" name="group_priority" context="{'group_by': 'priority'}"/>
            <filter string="Maintenance Team" name="group_maintenance_team" context="{'group_by': 'maintenance_team_id'}"/>
            <filter string="Start Date" name="group_start_date" context="{'group_by': 'start_date:month'}"/>
            </search>
        </field>
    </record>

    <!-- Planned Maintenance Work Order Calendar View -->
    <record id="view_planned_maintenance_workorder_calendar" model="ir.ui.view">
        <field name="name">facilities.workorder.planned.calendar</field>
        <field name="model">facilities.workorder</field>
        <field name="priority" eval="15"/>
        <field name="arch" type="xml">
            <calendar string="Planned Maintenance Calendar"
                      date_start="start_date"
                      date_stop="end_date"
                      color="priority">
                <field name="name"/>
                <field name="asset_id"/>
                <field name="technician_id"/>
                <field name="status"/>
                <field name="priority"/>
                <field name="sla_status"/>
                <field name="schedule_id"/>
                <field name="job_plan_id"/>
            </calendar>
        </field>
    </record>

    <!-- Planned Maintenance Work Order Kanban View -->
    <record id="view_planned_maintenance_workorder_kanban" model="ir.ui.view">
        <field name="name">facilities.workorder.planned.kanban</field>
        <field name="model">facilities.workorder</field>
        <field name="priority" eval="15"/>
        <field name="arch" type="xml">
            <kanban default_group_by="status" class="o_kanban_small_column">
                <field name="name"/>
                <field name="status"/>
                <field name="approval_state"/>
                <field name="asset_id"/>
                <field name="facility_id"/>
                <field name="technician_id"/>
                <field name="priority"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="schedule_id"/>
                <field name="job_plan_id"/>
                <field name="sla_status"/>
                <field name="escalation_triggered"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                        <br/>
                                        <small class="o_kanban_record_subtitle text-muted">
                                            <field name="asset_id"/>
                                        </small>
                                    </div>
                                    <div class="o_kanban_record_top_right">
                                        <field name="priority" widget="priority"/>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Facility:</small><br/>
                                            <field name="facility_id"/>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Technician:</small><br/>
                                            <field name="technician_id"/>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">Start Date:</small><br/>
                                            <field name="start_date"/>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">End Date:</small><br/>
                                            <field name="end_date"/>
                                        </div>
                                    </div>
                                    <div class="row mt-2" invisible="not schedule_id">
                                        <div class="col-12">
                                            <small class="text-muted">Schedule:</small><br/>
                                            <field name="schedule_id"/>
                                        </div>
                                    </div>
                                    <div class="row mt-2" invisible="not job_plan_id">
                                        <div class="col-12">
                                            <small class="text-muted">Job Plan:</small><br/>
                                            <field name="job_plan_id"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="status" widget="badge" 
                                               decoration-info="status=='draft'" 
                                               decoration-warning="status=='in_progress'" 
                                               decoration-success="status=='done'" 
                                               decoration-danger="status=='cancelled'"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="sla_status" widget="badge" 
                                               options="{'classes': {'on_time': 'success', 'at_risk': 'warning', 'breached': 'danger'}}"/>
                                        <field name="escalation_triggered" widget="boolean_toggle" 
                                               invisible="not escalation_triggered"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
</odoo>
